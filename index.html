<script>
/* ========== æ ¸å¿ƒé…ç½® ========== */
const DB_KEY = 'my_prompts_db_v5';

/* âœ… ä¸ä½ å½“å‰ä»“åº“ç»“æ„åŒ¹é… */
const GITHUB_DATA_URL = './prompts.json';

let currentEditingId = null;

/* ========== é¡µé¢åŠ è½½ ========== */
window.onload = function () {
  initData();
};

/* ========== åˆå§‹åŒ–é€»è¾‘ ========== */
async function initData() {
  const localData = getSavedData();

  if (localData.length === 0) {
    console.log("æœ¬åœ°æ— æ•°æ®ï¼Œå°è¯•ä» GitHub åŠ è½½");
    await fetchAndSaveData();
  } else {
    console.log("æœ¬åœ°å·²æœ‰æ•°æ®ï¼Œç›´æ¥æ¸²æŸ“");
    renderList();
  }
}

/* ========== æ‰‹åŠ¨å¼ºåˆ¶åˆ·æ–° ========== */
async function forceFetchGithub() {
  if (
    confirm(
      "ç¡®å®šè¦é‡æ–°åŠ è½½ GitHub æ•°æ®å—ï¼Ÿ\n\nâš ï¸ ä¼šè¦†ç›–å½“å‰æ‰€æœ‰æœ¬åœ°æ•°æ®\nğŸ‘‰ å»ºè®®å…ˆã€å¯¼å‡ºå¤‡ä»½ã€‘"
    )
  ) {
    await fetchAndSaveData();
  }
}

/* ========== ä» GitHub æ‹‰æ•°æ®ï¼ˆé˜²è¯¯æ¸…ç©ºç‰ˆï¼‰ ========== */
async function fetchAndSaveData() {
  try {
    const response = await fetch(GITHUB_DATA_URL, { cache: "no-store" });

    if (!response.ok) {
      throw new Error("GitHub æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨");
    }

    const serverData = await response.json();

    /* ğŸ”’ å…³é”®é˜²æŠ¤ï¼šç©ºæ•°æ®ä¸è¦†ç›–æœ¬åœ° */
    if (!Array.isArray(serverData) || serverData.length === 0) {
      alert("âš ï¸ GitHub æ•°æ®ä¸ºç©ºï¼Œå·²å–æ¶ˆè¦†ç›–æœ¬åœ°æ•°æ®");
      return;
    }

    localStorage.setItem(DB_KEY, JSON.stringify(serverData));
    renderList();

    alert(`âœ… æˆåŠŸåŠ è½½ ${serverData.length} æ¡æç¤ºè¯`);

  } catch (err) {
    console.error(err);

    if (location.protocol === "file:") {
      alert("âš ï¸ è¯·ä½¿ç”¨ GitHub Pages è®¿é—®ï¼Œç›´æ¥æ‰“å¼€ HTML ä¼šè¢«æµè§ˆå™¨æ‹¦æˆª");
    } else {
      alert("âŒ GitHub æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·æ£€æŸ¥è·¯å¾„æˆ–ç½‘ç»œ");
    }
  }
}

/* ========== æœ¬åœ°æ•°æ®è¯»å– ========== */
function getSavedData() {
  const data = localStorage.getItem(DB_KEY);
  return data ? JSON.parse(data) : [];
}
</script>
